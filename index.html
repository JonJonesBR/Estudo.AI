<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudo.AI: Gerador de Questões e Resumos</title>
    <meta name="description" content="Ferramenta inteligente para gerar questões e resumos usando IA do Google Gemini">
    <meta name="keywords" content="estudo, AI, questões, resumos, educação">
    
    <!-- Scripts externos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        // Define o worker globalmente para o pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.5.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* --- NOVA PALETA DE CORES PASTEL --- */
        :root {
            --primary-color: #8ecae6; /* Azul céu pastel */
            --secondary-color: #219ebc; /* Azul-petróleo complementar */
            --accent-color: #ffb703; /* Amarelo-mostarda suave */
            --success-color: #83c5be; /* Verde-menta suave */
            --warning-color: #ffb703; /* Amarelo-mostarda suave */
            --error-color: #e76f51; /* Vermelho-tijolo suave */
            
            /* Fundos limpos e suaves */
            --bg-primary: #ffffff; /* Branco (cards) */
            --bg-secondary: #f8f9fa; /* Cinza-gelo (fundo da página) */
            
            /* Textos de alto contraste */
            --text-primary: #023047; /* Azul-marinho escuro (quase preto) */
            --text-secondary: #495057; /* Cinza-médio */
            --border-color: #dee2e6; /* Cinza-claro */
        }
        /* --- FIM DA NOVA PALETA --- */

        * {
            transition: all 0.2s ease-in-out;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .theme-transition {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white; /* Texto branco funciona bem com este gradiente */
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transform: translateY(0);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(33, 158, 188, 0.2);
        }
        
        .btn-primary:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .input-field {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(142, 202, 230, 0.3);
        }
        
        /* Estilo para input[type=range] */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }

        input[type=range]:hover {
            opacity: 1;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Estilo para input[type=checkbox] */
        input[type=checkbox] {
            accent-color: var(--primary-color);
            width: 16px;
            height: 16px;
        }

        .loader {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 2px;
            transform: translateX(-100%);
            animation: progress 3s ease-in-out infinite;
        }

        @keyframes progress {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(0%); }
            100% { transform: translateX(100%); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-primary);
            color: var(--bg-primary);
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: var(--text-primary); /* Texto escuro para contraste com pastel */
            border-radius: 12px;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .floating-action {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .floating-action:hover {
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--bg-primary);
            margin: 5% auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--text-primary);
        }
        
        /* Estilos para o conteúdo do resumo (Markdown) */
        .prose {
            color: var(--text-primary);
            line-height: 1.7;
        }
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: var(--text-primary);
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }
        .prose h1 { font-size: 1.875rem; } /* text-3xl */
        .prose h2 { font-size: 1.5rem; } /* text-2xl */
        .prose h3 { font-size: 1.25rem; } /* text-xl */
        .prose p { margin-bottom: 1em; }
        .prose ul {
            list-style-type: disc;
            padding-left: 1.5em;
            margin-bottom: 1em;
        }
        .prose li { margin-bottom: 0.25em; }
        .prose strong { 
            font-weight: 700; 
            color: var(--text-primary);
        }
        .prose em { font-style: italic; }


        @media (max-width: 768px) {
            /* O container do Tailwind já é responsivo, mas podemos forçar um padding específico */
            .container {
                padding-left: 16px;
                padding-right: 16px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                margin: 10% auto;
                width: 95%;
            }
        }
        
        /* Ajuste para telas muito pequenas */
        @media (max-width: 480px) {
             .btn-primary, .btn-secondary {
                 padding: 10px 16px; /* Reduz o padding dos botões */
                 font-size: 14px; /* Reduz a fonte dos botões */
             }
             
             .card {
                 padding: 16px; /* Reduz o padding dos cards */
             }
             
             h1.text-2xl {
                 font-size: 1.25rem; /* Equivalente a text-xl */
             }
             
             .text-3xl {
                  font-size: 1.5rem; /* Equivalente a text-2xl */
             }
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white !important;
                color: black !important;
            }
            
            .card {
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>

<body class="theme-transition"> <!-- Removido data-theme="light" -->
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="card text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-sm">Processando com IA...</p>
            <div class="progress-bar mt-4">
                <div class="progress-fill"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="card no-print mb-6 sticky top-0 z-40">
        <div class="container mx-auto">
            <!-- AJUSTE: Alterado para flex-col em telas pequenas (sm) e flex-row em telas maiores, com gap -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-brain text-3xl" style="color: var(--primary-color);"></i>
                    <div>
                        <h1 class="text-2xl font-bold" style="color: var(--secondary-color);">Estudo.AI</h1>
                        <p class="text-sm" style="color: var(--text-secondary);">Gerador Inteligente de Questões</p>
                    </div>
                </div>
                
                <!-- AJUSTE: Botão de Tema Removido -->
                <div class="flex items-center space-x-2 sm:space-x-4 flex-wrap justify-center">
                    <!-- Settings -->
                    <button id="settingsBtn" class="btn-secondary tooltip">
                        <i class="fas fa-cog"></i>
                        <span class="tooltiptext">Configurações</span>
                    </button>
                    
                    <!-- Stats -->
                    <button id="statsBtn" class="btn-secondary tooltip">
                        <i class="fas fa-chart-bar"></i>
                        <span class="tooltiptext">Estatísticas</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- AJUSTE: O padding horizontal (px-4) foi movido do container para o body (ou pode ser aplicado ao container globalmente) -->
    <div class="container mx-auto flex-grow px-4 sm:px-0">
        <!-- Breadcrumb -->
        <nav class="breadcrumb no-print">
            <i class="fas fa-home"></i>
            <span class="breadcrumb-separator">/</span>
            <span id="currentStep">Início</span>
        </nav>

        <!-- Welcome Section -->
        <div id="welcomeSection" class="card mb-8 fade-in">
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold mb-4">Bem-vindo ao Estudo.AI!</h2>
                <p class="text-lg max-w-3xl mx-auto" style="color: var(--text-secondary);">
                    Transforme seus materiais de estudo em questões personalizadas ou resumos inteligentes usando o poder da IA.
                </p>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid mb-6">
                <div class="stat-card">
                    <i class="fas fa-question-circle text-2xl mb-2"></i>
                    <div class="text-2xl font-bold" id="totalQuestionsStat">0</div>
                    <div class="text-sm opacity-90">Questões Geradas</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-file-alt text-2xl mb-2"></i>
                    <div class="text-2xl font-bold" id="totalSummariesStat">0</div>
                    <div class="text-sm opacity-90">Resumos Criados</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-clock text-2xl mb-2"></i>
                    <div class="text-2xl font-bold" id="studyTimeStat">0m</div>
                    <div class="text-sm opacity-90">Tempo de Estudo</div>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="mb-6 p-4 border rounded-lg" style="background-color: #fffbeb; border-color: #fde68a; color: #b45309;">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-xl mt-1"></i>
                    <div>
                        <p class="font-bold">Configuração Necessária:</p>
                        <p class="mb-2">Para usar as funcionalidades de IA, insira sua chave da API do Google Gemini:</p>
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="hover:underline" style="color: var(--secondary-color);">
                            <i class="fas fa-external-link-alt"></i> Obter Chave API Gratuita
                        </a>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <label for="apiKey" class="block text-sm font-medium mb-2">
                    <i class="fas fa-key"></i> Chave API do Google Gemini:
                </label>
                <!-- AJUSTE: Adicionado flex-wrap para quebra de linha em telas pequenas -->
                <div class="flex flex-wrap sm:flex-nowrap gap-2">
                    <input 
                        type="password" 
                        id="apiKey" 
                        class="input-field flex-1 min-w-[200px]"
                        placeholder="Insira sua chave API aqui..."
                        aria-label="Chave API do Google Gemini"
                    >
                    <button id="toggleApiKey" class="btn-secondary tooltip">
                        <i class="fas fa-eye"></i>
                        <span class="tooltiptext">Mostrar/ocultar chave</span>
                    </button>
                    <button id="saveApiKey" class="btn-primary tooltip">
                        <i class="fas fa-save"></i>
                        <span class="tooltiptext">Salvar localmente (opcional)</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <!-- AJUSTE: Alterado de lg:grid-cols-3 para md:grid-cols-3 para layout mudar em telas médias -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Input Section -->
            <!-- AJUSTE: Alterado de lg:col-span-2 para md:col-span-2 -->
            <div class="md:col-span-2">
                <div class="card mb-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-edit" style="color: var(--primary-color);"></i>
                        <span class="ml-2">Material de Estudo</span>
                    </h3>

                    <!-- File Upload -->
                    <div class="mb-6 p-4 border-2 border-dashed rounded-lg text-center" style="border-color: var(--border-color);">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm mb-2" style="color: var(--text-secondary);">Arraste arquivos aqui ou clique para selecionar</p>
                        <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt" multiple>
                        <button id="fileSelectBtn" class="btn-secondary">
                            <i class="fas fa-folder-open"></i> Selecionar Arquivos
                        </button>
                        <div id="fileList" class="mt-2 text-sm" style="color: var(--text-secondary);"></div>
                    </div>

                    <!-- Study Materials -->
                    <div id="studyMaterials">
                        <div class="study-block mb-4">
                            <!-- AJUSTE: Adicionado flex-wrap para telas pequenas -->
                            <div class="flex flex-wrap items-center justify-between mb-2 gap-2">
                                <label class="block text-sm font-medium">
                                    <i class="fas fa-book"></i> Material 1:
                                </label>
                                <div class="flex items-center space-x-2">
                                    <input 
                                        type="number" 
                                        class="input-field w-20" 
                                        placeholder="5" 
                                        min="1" 
                                        max="50"
                                        aria-label="Número de questões para este material"
                                    >
                                    <span class="text-sm" style="color: var(--text-secondary);">questões</span>
                                </div>
                            </div>
                            <textarea 
                                class="input-field h-32 resize-none" 
                                placeholder="Cole seu material de estudo aqui... (artigos, anotações, livros, etc.)"
                                aria-label="Material de estudo 1"
                            ></textarea>
                            <div class="text-xs mt-1" style="color: var(--text-secondary);">
                                <span class="char-count">0</span> caracteres
                            </div>
                        </div>
                    </div>

                    <button id="addMaterialBtn" class="btn-secondary w-full mb-4">
                        <i class="fas fa-plus"></i> Adicionar Outro Material
                    </button>

                    <!-- Settings Row -->
                    <!-- AJUSTE: Alterado para 1 coluna em telas pequenas e 2 em sm+ -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                <i class="fas fa-hashtag"></i> Total de Questões:
                            </label>
                            <input 
                                type="number" 
                                id="totalQuestionsInput"
                                class="input-field" 
                                value="5" 
                                min="1" 
                                max="50"
                                aria-label="Número total de questões"
                            >
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">
                                <i class="fas fa-layer-group"></i> Dificuldade:
                            </label>
                            <select id="difficulty" class="input-field" aria-label="Nível de dificuldade">
                                <option value="easy">Fácil</option>
                                <option value="medium" selected>Médio</option>
                                <option value="hard">Difícil</option>
                                <option value="mixed">Misto</option>
                            </select>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <!-- AJUSTE: grid-cols-2 em telas pequenas e sm, lg:grid-cols-4 mantido -->
                    <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <button id="generateMultiple" class="btn-primary">
                            <i class="fas fa-list-ul"></i> Múltipla Escolha
                        </button>
                        <button id="generateTrueFalse" class="btn-primary">
                            <i class="fas fa-check-circle"></i> Verdadeiro/Falso
                        </button>
                        <button id="generateOpen" class="btn-primary">
                            <i class="fas fa-pen"></i> Questões Abertas
                        </button>
                        <button id="generateSummary" class="btn-primary">
                            <i class="fas fa-file-alt"></i> Resumo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Quick Actions -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-bolt" style="color: var(--accent-color);"></i>
                        <span class="ml-2">Ações Rápidas</span>
                    </h3>
                    <div class="space-y-2">
                        <button id="clearAll" class="btn-secondary w-full">
                            <i class="fas fa-trash"></i> Limpar Tudo
                        </button>
                        <button id="exportBtn" class="btn-secondary w-full">
                            <i class="fas fa-download"></i> Exportar
                        </button>
                        <button id="printBtn" class="btn-secondary w-full">
                            <i class="fas fa-print"></i> Imprimir
                        </button>
                    </div>
                </div>

                <!-- Timer Widget -->
                <div id="timerWidget" class="card hidden">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-stopwatch" style="color: var(--success-color);"></i>
                        <span class="ml-2">Timer do Quiz</span>
                    </h3>
                    <div class="text-center">
                        <div id="timerDisplay" class="timer-display mb-4">00:00</div>
                        <!-- AJUSTE: Botões do timer podem quebrar linha em telas pequenas -->
                        <div class="flex flex-wrap gap-2">
                            <button id="startTimer" class="btn-primary flex-1">
                                <i class="fas fa-play"></i> Iniciar
                            </button>
                            <button id="pauseTimer" class="btn-secondary flex-1">
                                <i class="fas fa-pause"></i> Pausar
                            </button>
                            <button id="resetTimer" class="btn-secondary flex-1">
                                <i class="fas fa-stop"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-history" style="color: #9b59b6;"></i> <!-- Roxo pastel -->
                        <span class="ml-2">Sessões Recentes</span>
                    </h3>
                    <div id="recentSessions" class="space-y-2">
                        <p class="text-sm text-center py-4" style="color: var(--text-secondary);">
                            Nenhuma sessão ainda
                        </p>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">
                        <i class="fas fa-keyboard" style="color: var(--text-secondary);"></i>
                        <span class="ml-2">Atalhos</span>
                    </h3>
                    <div class="text-sm space-y-1">
                        <div class="flex justify-between">
                            <span>Ctrl + M</span>
                            <span>Múltipla Escolha</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ctrl + T</span>
                            <span>Verdadeiro/Falso</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ctrl + S</span>
                            <span>Resumo</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Ctrl + D</span>
                            <span>Tema (Removido)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Output Section -->
        <div id="outputSection" class="mt-8 hidden">
            <!-- Results Header -->
            <div class="card mb-6">
                <!-- AJUSTE: flex-col em telas pequenas, sm:flex-row em maiores -->
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                    <h2 class="text-2xl font-bold">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        <span class="ml-2">Resultado Gerado</span>
                    </h2>
                    <div class="flex items-center space-x-2">
                        <button id="regenerateBtn" class="btn-secondary tooltip">
                            <i class="fas fa-redo"></i>
                            <span class="tooltiptext">Regenerar conteúdo</span>
                        </button>
                        <button id="searchBtn" class="btn-secondary tooltip">
                            <i class="fas fa-search"></i>
                            <span class="tooltiptext">Buscar no conteúdo</span>
                        </button>
                    </div>
                </div>
                
                <!-- Search Bar -->
                <div id="searchBar" class="mt-4 hidden">
                    <input 
                        type="text" 
                        id="searchInput" 
                        class="input-field" 
                        placeholder="Buscar questões ou conteúdo..."
                    >
                </div>
            </div>

            <!-- Quiz Section -->
            <div id="quizSection" class="hidden">
                <div class="card">
                    <!-- AJUSTE: flex-col em telas pequenas, sm:flex-row em maiores -->
                    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                        <h3 class="text-xl font-semibold">Quiz Interativo</h3>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <div id="quizProgress" class="text-sm" style="color: var(--text-secondary);">
                                Questão <span id="currentQuestion">1</span> de <span id="totalQuizQuestions">5</span>
                            </div>
                            <button id="checkAnswers" class="btn-primary">
                                <i class="fas fa-check"></i> Verificar Respostas
                            </button>
                        </div>
                    </div>
                    <div id="questionsContainer"></div>
                    
                    <!-- Quiz Results -->
                    <div id="quizResults" class="hidden mt-6 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold mb-4">Resultados do Quiz</h4>
                        <!-- AJUSTE: md:grid-cols-3 para 3 colunas em telas médias -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="text-center p-4 rounded-lg" style="background-color: #f0fdf4;">
                                <div class="text-2xl font-bold" style="color: var(--success-color);" id="correctCount">0</div>
                                <div class="text-sm" style="color: var(--success-color);">Corretas</div>
                            </div>
                            <div class="text-center p-4 rounded-lg" style="background-color: #fef2f2;">
                                <div class="text-2xl font-bold" style="color: var(--error-color);" id="incorrectCount">0</div>
                                <div class="text-sm" style="color: var(--error-color);">Incorretas</div>
                            </div>
                            <div class="text-center p-4 rounded-lg" style="background-color: #eff6ff;">
                                <div class="text-2xl font-bold" style="color: var(--primary-color);" id="scorePercent">0%</div>
                                <div class="text-sm" style="color: var(--primary-color);">Aproveitamento</div>
                            </div>
                        </div>
                        <div id="recommendations" class="mt-4"></div>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div id="summarySection" class="hidden">
                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">Resumo Inteligente</h3>
                    <!-- AJUSTE: Adicionado overflow-x-auto para evitar quebra de layout por conteúdo largo (ex: tabelas) -->
                    <div id="summaryContent" class="prose max-w-none overflow-x-auto"></div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card mt-6 no-print">
                <h3 class="text-lg font-semibold mb-4">Opções de Exportação</h3>
                <div class="flex flex-wrap gap-2">
                    <button id="exportPDF" class="btn-secondary">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button id="exportJSON" class="btn-secondary">
                        <i class="fas fa-file-code"></i> JSON
                    </button>
                    <button id="exportTXT" class="btn-secondary">
                        <i class="fas fa-file-alt"></i> Texto
                    </button>
                    <button id="shareBtn" class="btn-secondary">
                        <i class="fas fa-share"></i> Compartilhar
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Messages -->
        <div id="errorMessage" class="fixed top-4 right-4 text-white p-4 rounded-lg shadow-lg hidden z-50 max-w-[90vw]" style="background-color: var(--error-color);">
            <div class="flex items-center space-x-2">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText"></span>
                <button id="closeError" class="ml-4 text-white hover:text-gray-200" aria-label="Fechar erro">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Success Messages -->
        <div id="successMessage" class="fixed top-4 right-4 text-white p-4 rounded-lg shadow-lg hidden z-50 max-w-[90vw]" style="background-color: var(--success-color);">
            <div class="flex items-center space-x-2">
                <i class="fas fa-check-circle"></i>
                <span id="successText"></span>
                <button id="closeSuccess" class="ml-4 text-white hover:text-gray-200" aria-label="Fechar sucesso">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-cog mr-2"></i>
                    Configurações
                </h2>
                <span class="close" onclick="closeModal('settingsModal')">&times;</span>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-medium mb-3">Preferências de IA</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Modelo de IA:</label>
                            <select id="aiModel" class="input-field">
                                <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash (Recomendado)</option>
                                <option value="gemini-pro">Gemini Pro (Mais antigo)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Temperatura (Criatividade):</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" class="w-full">
                            <div class="text-sm" style="color: var(--text-secondary);">Valor: <span id="tempValue">0.7</span></div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-medium mb-3">Interface</h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="autoSave" class="rounded">
                            <label for="autoSave">Salvar progresso automaticamente</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="soundEffects" class="rounded">
                            <label for="soundEffects">Efeitos sonoros</label>
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="animations" class="rounded" checked>
                            <label for="animations">Animações</label>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-medium mb-3">Quiz</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Tempo padrão (minutos):</label>
                            <input type="number" id="defaultTime" class="input-field" value="15" min="1" max="120">
                        </div>
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="showExplanations" class="rounded" checked>
                            <label for="showExplanations">Mostrar explicações das respostas</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-8">
                <button onclick="closeModal('settingsModal')" class="btn-secondary">Cancelar</button>
                <button id="saveSettings" class="btn-primary">Salvar Configurações</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Estatísticas de Estudo
                </h2>
                <span class="close" onclick="closeModal('statsModal')">&times;</span>
            </div>
            
            <div id="statsContent">
                <!-- Stats will be populated here -->
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="scrollTop" class="floating-action hidden">
        <i class="fas fa-arrow-up"></i>
    </button>

    <footer class="text-center py-8 no-print px-4" style="color: var(--text-secondary);">
        <p>&copy; 2024 Estudo.AI - Ferramenta de estudo inteligente com IA</p>
        <p class="text-sm mt-2">
            <kbd>Ctrl + ?</kbd> para ver todos os atalhos
        </p>
    </footer>

    <!-- #################### SCRIPT BLOCK #################### -->
    <script>
        // Global variables
        // let currentTheme = 'light'; // Removido
        let timerInterval = null;
        let timerSeconds = 0;
        let isTimerRunning = false;
        let studyStats = JSON.parse(localStorage.getItem('studyStats')) || {
            totalQuestions: 0,
            totalSummaries: 0,
            totalStudyTime: 0,
            correctAnswers: 0,
            incorrectAnswers: 0,
            sessions: []
        };
        // Armazena o último tipo de geração para o botão "Regenerar"
        let lastGenerationType = null; 
        let isGenerating = false; // Trava para evitar cliques duplos

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadSettings();
            updateStatsDisplay();
        });

        function initializeApp() {
            // Load saved API key
            const savedApiKey = localStorage.getItem('gemini-api-key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }

            // Load saved theme - REMOVIDO
            // const savedTheme = localStorage.getItem('theme') || 'light';
            // setTheme(savedTheme);

            // Setup character counters
            setupCharacterCounters();
        }

        function setupEventListeners() {
            // Theme toggle - REMOVIDO
            // document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // API Key management
            document.getElementById('toggleApiKey').addEventListener('click', toggleApiKeyVisibility);
            document.getElementById('saveApiKey').addEventListener('click', saveApiKey);

            // File handling
            document.getElementById('fileSelectBtn').addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Material management
            document.getElementById('addMaterialBtn').addEventListener('click', addMaterialBlock);

            // Generation buttons
            document.getElementById('generateMultiple').addEventListener('click', () => generateContent('multiple'));
            document.getElementById('generateTrueFalse').addEventListener('click', () => generateContent('truefalse'));
            document.getElementById('generateOpen').addEventListener('click', () => generateContent('open'));
            document.getElementById('generateSummary').addEventListener('click', () => generateContent('summary'));

            // Quick actions
            document.getElementById('clearAll').addEventListener('click', clearAll);
            document.getElementById('exportBtn').addEventListener('click', showExportOptions);
            document.getElementById('printBtn').addEventListener('click', printContent);

            // Timer controls
            document.getElementById('startTimer').addEventListener('click', startTimer);
            document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
            document.getElementById('resetTimer').addEventListener('click', resetTimer);

            // Modal controls
            document.getElementById('settingsBtn').addEventListener('click', () => openModal('settingsModal'));
            document.getElementById('statsBtn').addEventListener('click', () => openModal('statsModal'));
            document.getElementById('saveSettings').addEventListener('click', saveSettings);

            // Export options
            document.getElementById('exportPDF').addEventListener('click', exportToPDF);
            document.getElementById('exportJSON').addEventListener('click', exportToJSON);
            document.getElementById('exportTXT').addEventListener('click', exportToTXT);

            // Quiz controls
            document.getElementById('checkAnswers').addEventListener('click', checkQuizAnswers);
            document.getElementById('regenerateBtn').addEventListener('click', regenerateContent);
            document.getElementById('searchBtn').addEventListener('click', toggleSearch);

            // Message controls
            document.getElementById('closeError').addEventListener('click', () => hideMessage('error'));
            document.getElementById('closeSuccess').addEventListener('click', () => hideMessage('success'));

            // Scroll to top
            document.getElementById('scrollTop').addEventListener('click', scrollToTop);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Auto-hide scroll button
            window.addEventListener('scroll', handleScroll);

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', searchContent);

            // Settings sliders
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('tempValue').textContent = e.target.value;
            });
        }

        // Theme management - REMOVIDO
        // function toggleTheme() { ... }
        // function setTheme(theme) { ... }

        // API Key management
        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById('apiKey');
            const toggleIcon = document.querySelector('#toggleApiKey i');
            
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                apiKeyInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        }

        function saveApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                localStorage.setItem('gemini-api-key', apiKey);
                showMessage('success', 'Chave API salva localmente com sucesso!');
            } else {
                showMessage('error', 'Por favor, insira uma chave API válida.');
            }
        }

        // Material management
        function addMaterialBlock() {
            const container = document.getElementById('studyMaterials');
            const blockCount = container.querySelectorAll('.study-block').length + 1;
            
            const newBlock = document.createElement('div');
            newBlock.className = 'study-block mb-4 slide-in';
            newBlock.innerHTML = `
                <div class="flex flex-wrap items-center justify-between mb-2 gap-2">
                    <label class="block text-sm font-medium">
                        <i class="fas fa-book"></i> Material ${blockCount}:
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="number" class="input-field w-20" placeholder="5" min="1" max="50" aria-label="Número de questões para este material ${blockCount}">
                        <span class="text-sm" style="color: var(--text-secondary);">questões</span>
                        <button class="btn-secondary remove-block !p-2" onclick="removeBlock(this)" aria-label="Remover Material ${blockCount}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <textarea class="input-field h-32 resize-none" placeholder="Cole seu material de estudo aqui..." aria-label="Material de estudo ${blockCount}"></textarea>
                <div class="text-xs mt-1" style="color: var(--text-secondary);">
                    <span class="char-count">0</span> caracteres
                </div>
            `;
            
            container.appendChild(newBlock);
            setupCharacterCounters(); // Re-aplicar contadores
        }

        function removeBlock(button) {
            // Não permite remover o último bloco
            if (document.querySelectorAll('.study-block').length === 1) {
                showMessage('warning', 'Você não pode remover o último bloco de material.');
                return;
            }
            const block = button.closest('.study-block');
            block.remove();
            reindexStudyBlocks();
        }

        function reindexStudyBlocks() {
            const blocks = document.querySelectorAll('.study-block');
            blocks.forEach((block, index) => {
                const blockNumber = index + 1;
                const label = block.querySelector('label');
                label.innerHTML = `<i class="fas fa-book"></i> Material ${blockNumber}:`;
                block.querySelector('textarea').setAttribute('aria-label', `Material de estudo ${blockNumber}`);
                block.querySelector('input[type="number"]').setAttribute('aria-label', `Número de questões para este material ${blockNumber}`);
                block.querySelector('.remove-block').setAttribute('aria-label', `Remover Material ${blockNumber}`);
            });
        }


        function setupCharacterCounters() {
            const textareas = document.querySelectorAll('#studyMaterials textarea');
            textareas.forEach(textarea => {
                // Evita adicionar múltiplos listeners
                if (textarea.dataset.listenerAttached) return;

                const counter = textarea.parentNode.querySelector('.char-count');
                const updateCount = () => {
                    if (counter) { // Verifica se o contador existe
                         counter.textContent = textarea.value.length;
                    }
                };
                
                textarea.addEventListener('input', updateCount);
                textarea.dataset.listenerAttached = 'true';
                updateCount(); // Atualiza contagem inicial
            });
        }

        // File handling
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = ''; // Limpa lista anterior

            if (files.length === 0) return;

            // Mostra os arquivos selecionados
            fileList.innerHTML = files.map(file => 
                `<div class="flex items-center space-x-2 text-sm p-1">
                    <i class="fas fa-file"></i>
                    <span>${file.name}</span>
                    <span class="text-gray-500">(${formatFileSize(file.size)})</span>
                </div>`
            ).join('');
            
            // Processa os arquivos
            files.forEach((file, index) => {
                // Coloca o conteúdo do primeiro arquivo no primeiro textarea, os seguintes em novos blocos
                let targetTextarea;
                if (index === 0) {
                    targetTextarea = document.querySelector('#studyMaterials textarea');
                } else {
                    addMaterialBlock();
                    targetTextarea = document.querySelector('#studyMaterials .study-block:last-child textarea');
                }
                
                if (targetTextarea) {
                    processFile(file, targetTextarea);
                }
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function processFile(file, textarea) {
            const reader = new FileReader();
            
            reader.onloadstart = () => showLoading(true);
            reader.onerror = () => {
                showMessage('error', `Erro ao ler o arquivo ${file.name}.`);
                showLoading(false);
            };
            
            reader.onload = function(e) {
                try {
                    if (file.type === 'application/pdf') {
                        // Usar pdf.js
                        const loadingTask = pdfjsLib.getDocument({data: e.target.result});
                        loadingTask.promise.then(pdf => {
                            let text = '';
                            let promises = [];
                            for (let i = 1; i <= pdf.numPages; i++) {
                                promises.push(pdf.getPage(i).then(page => page.getTextContent()));
                            }
                            
                            Promise.all(promises).then(contents => {
                                contents.forEach(content => {
                                    content.items.forEach(item => {
                                        text += item.str + ' ';
                                    });
                                    text += '\n'; // Nova página
                                });
                                textarea.value = text;
                                textarea.dispatchEvent(new Event('input')); // Update char counter
                                showLoading(false);
                            });
                        }).catch(err => {
                             showMessage('error', `Erro ao processar PDF: ${err.message}`);
                             showLoading(false);
                        });
                        
                    } else if (file.type === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {
                        // Usar mammoth.js
                        mammoth.extractRawText({arrayBuffer: e.target.result})
                            .then(result => {
                                textarea.value = result.value;
                                textarea.dispatchEvent(new Event('input'));
                                showLoading(false);
                            })
                            .catch(err => {
                                showMessage('error', `Erro ao processar DOCX: ${err.message}`);
                                showLoading(false);
                            });

                    } else if (file.type === 'text/plain') {
                        textarea.value = e.target.result;
                        textarea.dispatchEvent(new Event('input'));
                        showLoading(false);
                    } else {
                         showMessage('warning', `Formato de arquivo não suportado: ${file.type}`);
                         showLoading(false);
                    }
                } catch (error) {
                    showMessage('error', `Erro inesperado ao processar arquivo: ${error.message}`);
                    showLoading(false);
                }
            };
            
            if (file.type === 'application/pdf' || file.type.includes('word')) {
                reader.readAsArrayBuffer(file);
            } else if (file.type === 'text/plain') {
                 reader.readAsText(file);
            } else {
                 showMessage('warning', `Arquivo ${file.name} ignorado (formato não suportado).`);
            }
        }


        // Content generation
        async function generateContent(type) {
            if (isGenerating) {
                showMessage('warning', 'Aguarde, geração anterior em progresso.');
                return;
            }
            
            lastGenerationType = type; // Salva o tipo para "Regenerar"
            const apiKey = document.getElementById('apiKey').value.trim();
            
            if (!apiKey) {
                showMessage('error', 'Por favor, insira sua chave API do Google Gemini.');
                return;
            }

            const materials = getMaterials();
            if (materials.length === 0 || materials.every(m => m.content.length === 0)) {
                showMessage('error', 'Por favor, adicione pelo menos um material de estudo.');
                return;
            }
            
            isGenerating = true;
            setGenerationButtonsDisabled(true);
            showLoading(true);
            updateBreadcrumb('Gerando conteúdo...');

            try {
                // ########### CHAMADA REAL DA API ###########
                const result = await callGeminiAPI(type, materials, apiKey); 
                // #########################################
                
                displayResult(type, result);
                updateStats(type);
                saveSession(type, materials, result);
                
                showMessage('success', 'Conteúdo gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar conteúdo:', error);
                showMessage('error', `Erro ao gerar conteúdo: ${error.message}`);
            } finally {
                showLoading(false);
                isGenerating = false;
                setGenerationButtonsDisabled(false);
                updateBreadcrumb('Resultado');
            }
        }
        
        function setGenerationButtonsDisabled(disabled) {
            document.getElementById('generateMultiple').disabled = disabled;
            document.getElementById('generateTrueFalse').disabled = disabled;
            document.getElementById('generateOpen').disabled = disabled;
            document.getElementById('generateSummary').disabled = disabled;
        }

        function getMaterials() {
            const blocks = document.querySelectorAll('.study-block');
            const materials = [];
            
            blocks.forEach(block => {
                const textarea = block.querySelector('textarea');
                const questionCountInput = block.querySelector('input[type="number"]');
                
                if (textarea.value.trim()) {
                    materials.push({
                        content: textarea.value.trim(),
                        questionCount: parseInt(questionCountInput.value) || 5 
                    });
                }
            });
            
            return materials;
        }

        // ########### FUNÇÃO REAL DA API GEMINI ###########
        async function callGeminiAPI(type, materials, apiKey) {
            const difficulty = document.getElementById('difficulty').value;
            const totalQuestions = document.getElementById('totalQuestionsInput').value;
            const aiModel = document.getElementById('aiModel').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            
            const combinedContent = materials.map(m => `--- Início Material ${materials.indexOf(m) + 1} ---\n${m.content}\n--- Fim Material ${materials.indexOf(m) + 1} ---`).join('\n\n');

            let systemInstruction = "Você é um assistente educacional especialista em criar materiais de estudo. Responda em português brasileiro.";
            let userQuery = "";
            let responseMimeType = "text/plain";
            
            // Define o prompt e o tipo de resposta esperado
            if (type === 'summary') {
                userQuery = `Crie um resumo detalhado e bem estruturado (em formato markdown) do seguinte conteúdo, destacando os pontos principais, conceitos-chave e informações importantes.
                
                Conteúdo:
                ${combinedContent}`;
            } else {
                // Para questões, pedimos JSON
                responseMimeType = "application/json";
                systemInstruction += " Responda APENAS com o objeto JSON solicitado, sem nenhum texto adicional antes ou depois.";
                
                if (type === 'multiple') {
                    userQuery = `Gere ${totalQuestions} questões de múltipla escolha (nível ${difficulty}) baseadas no conteúdo abaixo.
                    O JSON deve ter o formato: { "questions": [{ "question": "...", "options": ["A) ...", "B) ...", "C) ...", "D) ..."], "correct": 0, "explanation": "..." }] }
                    Onde "correct" é o índice (base 0) da opção correta.
                    
                    Conteúdo: ${combinedContent}`;
                } else if (type === 'truefalse') {
                    userQuery = `Gere ${totalQuestions} questões de Verdadeiro/Falso (nível ${difficulty}) baseadas no conteúdo abaixo.
                    O JSON deve ter o formato: { "questions": [{ "question": "...", "correct": true, "explanation": "..." }] }
                    Onde "correct" é um booleano (true/false).
                    
                    Conteúdo: ${combinedContent}`;
                } else if (type === 'open') {
                     userQuery = `Gere ${totalQuestions} questões abertas (discursivas) (nível ${difficulty}) baseadas no conteúdo abaixo.
                    O JSON deve ter o formato: { "questions": [{ "question": "...", "answer": "..." }] }
                    Onde "answer" é uma resposta modelo detalhada.
                    
                    Conteúdo: ${combinedContent}`;
                }
            }
            
            // Monta a URL e o Payload
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${aiModel}:generateContent?key=${apiKey}`;
            
            const payload = {
                systemInstruction: {
                    parts: [{ text: systemInstruction }]
                },
                contents: [
                    { parts: [{ text: userQuery }] }
                ],
                generationConfig: {
                    responseMimeType: responseMimeType,
                    temperature: temperature
                }
            };
            
            // Chama a API com retentativas
            const response = await fetchWithRetry(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                let errorMsg = `Erro na API: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.error?.message || errorMsg;
                } catch (e) {}
                throw new Error(errorMsg);
            }

            const data = await response.json();
            
            // Processa a resposta
            const candidate = data.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text;

            if (!text) {
                if (candidate?.finishReason === 'SAFETY') {
                    throw new Error("A resposta foi bloqueada por motivos de segurança. Tente reformular o material.");
                }
                throw new Error("A API não retornou nenhum conteúdo.");
            }
            
            if (type === 'summary') {
                return text; // Retorna o texto markdown
            } else {
                // Para JSON, faz o parse do texto retornado
                return parseAIJson(text);
            }
        }
        
        /**
         * Tenta analisar uma string JSON que pode estar "suja" (ex: com ```json ... ```)
         */
        function parseAIJson(text) {
             try {
                // Tenta analisar diretamente
                return JSON.parse(text);
            } catch (e) {
                // Se falhar, tenta limpar
                console.warn("JSON direto falhou, tentando limpar...");
                const match = text.match(/\{[\s\S]*\}/); // Encontra o primeiro { ... }
                if (match) {
                    try {
                        return JSON.parse(match[0]);
                    } catch (e2) {
                        console.error("Falha ao analisar JSON limpo:", e2);
                        throw new Error("A IA retornou um JSON em formato inválido.");
                    }
                }
                throw new Error("A IA não retornou um JSON válido.");
            }
        }
        
        /**
         * Wrapper de Fetch com retentativas (exponential backoff)
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429 && retries > 0) { // Too Many Requests
                    console.warn(`API rate limit. Retentando em ${delay}ms... (${retries} retentativas restantes)`);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                return response;
            } catch (error) {
                if (retries > 0) {
                    console.warn(`Fetch falhou. Retentando em ${delay}ms...`, error.message);
                    await new Promise(res => setTimeout(res, delay));
                    return fetchWithRetry(url, options, retries - 1, delay * 2);
                }
                throw error; // Lança o erro após esgotar retentativas
            }
        }
        // ###################################################

        function displayResult(type, result) {
            const outputSection = document.getElementById('outputSection');
            const quizSection = document.getElementById('quizSection');
            const summarySection = document.getElementById('summarySection');
            
            // Limpa resultados anteriores
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('summaryContent').innerHTML = '';
            document.getElementById('quizResults').classList.add('hidden');

            outputSection.classList.remove('hidden');
            outputSection.classList.add('fade-in');
            
            if (type === 'summary') {
                quizSection.classList.add('hidden');
                summarySection.classList.remove('hidden');
                
                const summaryContent = document.getElementById('summaryContent');
                // Converte o Markdown retornado em HTML
                summaryContent.innerHTML = markdownToHtml(result); 
            } else {
                // Validação do resultado das questões
                if (!result || !result.questions || !Array.isArray(result.questions) || result.questions.length === 0) {
                    showMessage('error', 'A IA não retornou questões no formato esperado. Verifique o console para detalhes.');
                    console.error("Resultado inesperado da IA:", result);
                    return;
                }
                
                summarySection.classList.add('hidden');
                quizSection.classList.remove('hidden');
                
                displayQuiz(type, result.questions);
                
                const timerWidget = document.getElementById('timerWidget');
                timerWidget.classList.remove('hidden');
            }
            
            outputSection.scrollIntoView({ behavior: 'smooth' });
        }

        function displayQuiz(type, questions) {
            const container = document.getElementById('questionsContainer');
            const totalQuestionsEl = document.getElementById('totalQuizQuestions');
            const currentQuestionEl = document.getElementById('currentQuestion');
            
            totalQuestionsEl.textContent = questions.length;
            currentQuestionEl.textContent = '1'; // Reseta para a primeira questão
            
            container.innerHTML = questions.map((q, index) => {
                // Armazena a resposta correta no elemento
                let correctData = `data-correct="${q.correct}"`;

                if (type === 'multiple') {
                    // Validação simples
                    if (!q.options || q.options.length === 0) {
                         console.warn(`Questão ${index+1} (Múltipla) está sem opções.`);
                         return `<div class="p-4 border rounded-lg mb-4" style="background-color: #fef2f2; border-color: var(--error-color); color: var(--error-color);">Questão ${index+1} inválida (sem opções).</div>`;
                    }
                    return `
                        <div class="question-block mb-6 p-4 border rounded-lg" style="border-color: var(--border-color);" data-question-index="${index}" ${correctData}>
                            <h4 class="font-semibold mb-3">${index + 1}. ${q.question}</h4>
                            <div class="space-y-2">
                                ${q.options.map((option, optIndex) => `
                                    <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                        <input type="radio" name="q${index}" value="${optIndex}" class="text-blue-600">
                                        <span>${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                            <div class="explanation hidden mt-3 p-3 rounded-lg" style="background-color: #eff6ff; color: #1e40af;">
                                <strong>Explicação:</strong> ${q.explanation || 'N/A'}
                            </div>
                        </div>
                    `;
                } else if (type === 'truefalse') {
                    return `
                        <div class="question-block mb-6 p-4 border rounded-lg" style="border-color: var(--border-color);" data-question-index="${index}" ${correctData}>
                            <h4 class="font-semibold mb-3">${index + 1}. ${q.question}</h4>
                            <div class="space-y-2">
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="radio" name="q${index}" value="true" class="text-blue-600">
                                    <span>Verdadeiro</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                    <input type="radio" name="q${index}" value="false" class="text-blue-600">
                                    <span>Falso</span>
                                </label>
                            </div>
                            <div class="explanation hidden mt-3 p-3 rounded-lg" style="background-color: #eff6ff; color: #1e40af;">
                                <strong>Explicação:</strong> ${q.explanation || 'N/A'}
                            </div>
                        </div>
                    `;
                } else if (type === 'open') {
                    return `
                        <div class="question-block mb-6 p-4 border rounded-lg" style="border-color: var(--border-color);" data-question-index="${index}">
                            <h4 class="font-semibold mb-3">${index + 1}. ${q.question}</h4>
                            <textarea class="input-field h-24 resize-none" placeholder="Digite sua resposta aqui..."></textarea>
                            <div class="model-answer hidden mt-3 p-3 rounded-lg" style="background-color: #f0fdf4; color: #15803d;">
                                <strong>Resposta Modelo:</strong> ${q.answer || 'N/A'}
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function checkQuizAnswers() {
            const questions = document.querySelectorAll('.question-block');
            let correct = 0;
            let total = 0;
            const showExplanations = document.getElementById('showExplanations').checked;

            questions.forEach((questionEl) => {
                const explanation = questionEl.querySelector('.explanation');
                const modelAnswer = questionEl.querySelector('.model-answer');
                
                // Reseta estilos
                questionEl.style.backgroundColor = 'transparent';
                questionEl.style.borderColor = 'var(--border-color)';


                if (explanation) { // Múltipla escolha ou V/F
                    total++;
                    if (showExplanations) explanation.classList.remove('hidden');
                    
                    const correctAnswer = questionEl.dataset.correct;
                    const selectedInput = questionEl.querySelector('input[type="radio"]:checked');
                    
                    if (selectedInput) {
                        // Compara a resposta selecionada (string) com a correta (pode ser string 'true'/'false' ou índice numérico)
                        if (selectedInput.value == correctAnswer) {
                            correct++;
                            questionEl.style.backgroundColor = '#f0fdf4';
                            questionEl.style.borderColor = 'var(--success-color)';
                        } else {
                            questionEl.style.backgroundColor = '#fef2f2';
                            questionEl.style.borderColor = 'var(--error-color)';
                        }
                    }
                } else if (modelAnswer) { // Questão aberta
                    // Apenas mostra a resposta modelo, não há pontuação automática
                    modelAnswer.classList.remove('hidden');
                }
            });
            
            if (total > 0) {
                // Update results
                document.getElementById('correctCount').textContent = correct;
                document.getElementById('incorrectCount').textContent = total - correct;
                document.getElementById('scorePercent').textContent = Math.round((correct / total) * 100) + '%';
                
                document.getElementById('quizResults').classList.remove('hidden');
                
                studyStats.correctAnswers += correct;
                studyStats.incorrectAnswers += (total - correct);
                updateStatsDisplay();
                saveStats();
            } else {
                 document.getElementById('quizResults').classList.add('hidden');
                 if (document.querySelectorAll('.model-answer').length > 0) {
                     showMessage('success', 'Respostas modelo exibidas.');
                 }
            }
        }


        // Timer functions
        function startTimer() {
            if (!isTimerRunning) {
                isTimerRunning = true;
                timerInterval = setInterval(() => {
                    timerSeconds++;
                    updateTimerDisplay();
                }, 1000);
                
                document.getElementById('startTimer').classList.add('hidden');
                document.getElementById('pauseTimer').classList.remove('hidden');
            }
        }

        function pauseTimer() {
            if (isTimerRunning) {
                isTimerRunning = false;
                clearInterval(timerInterval);
                
                document.getElementById('startTimer').classList.remove('hidden');
                document.getElementById('pauseTimer').classList.add('hidden');
            }
        }

        function resetTimer() {
            if (isTimerRunning) {
                pauseTimer();
            }
            studyStats.totalStudyTime += Math.round(timerSeconds / 60); // Salva o tempo no reset
            timerSeconds = 0;
            updateTimerDisplay();
            updateStatsDisplay(); // Atualiza o total
            saveStats();
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Utility functions
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        function showMessage(type, message) {
            const messageEl = document.getElementById(type + 'Message');
            const textEl = document.getElementById(type + 'Text');
            
            textEl.textContent = message;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                hideMessage(type);
            }, 5000);
        }

        function hideMessage(type) {
            const messageEl = document.getElementById(type + 'Message');
            messageEl.classList.add('hidden');
        }

        function updateBreadcrumb(step) {
            document.getElementById('currentStep').textContent = step;
        }

        function updateStats(type) {
            if (type === 'summary') {
                studyStats.totalSummaries++;
            } else {
                // Contamos como 1 sessão de questões, não o número de questões
                studyStats.totalQuestions++; 
            }
            // O tempo de estudo é salvo no reset/pause do timer
            
            updateStatsDisplay();
            saveStats();
        }

        function updateStatsDisplay() {
            document.getElementById('totalQuestionsStat').textContent = studyStats.totalQuestions;
            document.getElementById('totalSummariesStat').textContent = studyStats.totalSummaries;
            document.getElementById('studyTimeStat').textContent = studyStats.totalStudyTime + 'm';
        }

        function saveStats() {
            localStorage.setItem('studyStats', JSON.stringify(studyStats));
        }

        function saveSession(type, materials, result) {
            const session = {
                id: Date.now(),
                type: type,
                timestamp: new Date().toISOString(),
                materialsCount: materials.length,
                materialsContent: materials.map(m => m.content.substring(0, 100) + '...'), // Salva trechos
                result: result // O resultado (questões ou resumo)
            };
            
            studyStats.sessions.unshift(session);
            if (studyStats.sessions.length > 10) {
                studyStats.sessions = studyStats.sessions.slice(0, 10);
            }
            
            saveStats();
            updateRecentSessions();
        }
        
        function loadSession(sessionId) {
            const session = studyStats.sessions.find(s => s.id == sessionId);
            if (!session) {
                showMessage('error', 'Sessão não encontrada.');
                return;
            }
            
            // Recarregar materiais (simplificado, apenas o primeiro)
            const materialBlocks = document.querySelectorAll('.study-block');
            // Remove todos, exceto o primeiro
            materialBlocks.forEach((block, index) => {
                if (index > 0) block.remove();
            });
            // Adiciona blocos se necessário (simplificado)
            const firstTextarea = document.querySelector('.study-block textarea');
            firstTextarea.value = session.materialsContent[0]; // Recarrega o trecho
            firstTextarea.dispatchEvent(new Event('input'));
            
            // Exibir resultado
            displayResult(session.type, session.result);
            showMessage('success', `Sessão de ${new Date(session.timestamp).toLocaleString()} carregada.`);
        }

        function updateRecentSessions() {
            const container = document.getElementById('recentSessions');
            
            if (studyStats.sessions.length === 0) {
                container.innerHTML = `<p class="text-sm text-center py-4" style="color: var(--text-secondary);">Nenhuma sessão ainda</p>`;
                return;
            }
            
            container.innerHTML = studyStats.sessions.slice(0, 5).map(session => `
                <div class="p-2 rounded text-sm cursor-pointer hover:bg-gray-200" style="background-color: #f8f9fa;" onclick="loadSession(${session.id})">
                    <div class="font-medium">${getSessionTypeLabel(session.type)}</div>
                    <div class="text-xs" style="color: var(--text-secondary);">${new Date(session.timestamp).toLocaleString()}</div>
                </div>
            `).join('');
        }

        function getSessionTypeLabel(type) {
            const labels = {
                'multiple': 'Múltipla Escolha',
                'truefalse': 'Verdadeiro/Falso',
                'open': 'Questões Abertas',
                'summary': 'Resumo'
            };
            return labels[type] || type;
        }

        // Modal functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            if (modalId === 'statsModal') {
                populateStats();
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function populateStats() {
            const statsContent = document.getElementById('statsContent');
            const accuracy = studyStats.correctAnswers + studyStats.incorrectAnswers > 0 
                ? Math.round((studyStats.correctAnswers / (studyStats.correctAnswers + studyStats.incorrectAnswers)) * 100)
                : 0;
                
            statsContent.innerHTML = `
                <div class="stats-grid mb-6">
                    <div class="stat-card">
                        <i class="fas fa-question-circle text-2xl mb-2"></i>
                        <div class="text-2xl font-bold">${studyStats.totalQuestions}</div>
                        <div class="text-sm opacity-90">Sessões de Questões</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-file-alt text-2xl mb-2"></i>
                        <div class="text-2xl font-bold">${studyStats.totalSummaries}</div>
                        <div class="text-sm opacity-90">Resumos Criados</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clock text-2xl mb-2"></i>
                        <div class="text-2xl font-bold">${studyStats.totalStudyTime}m</div>
                        <div class="text-sm opacity-90">Tempo de Estudo</div>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-chart-line text-2xl mb-2"></i>
                        <div class="text-2xl font-bold">${accuracy}%</div>
                        <div class="text-sm opacity-90">Precisão (Quiz)</div>
                    </div>
                </div>
                
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Histórico de Sessões</h3>
                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        ${studyStats.sessions.map(session => `
                            <div class="flex items-center justify-between p-3 rounded" style="background-color: var(--bg-secondary);">
                                <div>
                                    <div class="font-medium">${getSessionTypeLabel(session.type)}</div>
                                    <div class="text-sm" style="color: var(--text-secondary);">${new Date(session.timestamp).toLocaleString()}</div>
                                </div>
                                <div class="text-sm" style="color: var(--text-secondary);">
                                    ${session.materialsCount} material(is)
                                </div>
                            </div>
                        `).join('') || `<p class="text-center py-4" style="color: var(--text-secondary);">Nenhuma sessão registrada</p>`}
                    </div>
                </div>
            `;
        }

        // Settings functions
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {};
            
            document.getElementById('autoSave').checked = settings.autoSave || false;
            document.getElementById('soundEffects').checked = settings.soundEffects || false;
            document.getElementById('animations').checked = settings.animations !== undefined ? settings.animations : true;
            document.getElementById('showExplanations').checked = settings.showExplanations !== undefined ? settings.showExplanations : true;
            document.getElementById('defaultTime').value = settings.defaultTime || '15';
            document.getElementById('temperature').value = settings.temperature || '0.7';
            document.getElementById('tempValue').textContent = settings.temperature || '0.7';
            document.getElementById('aiModel').value = settings.aiModel || 'gemini-2.5-flash-preview-09-2025';
        }

        function saveSettings() {
            const settings = {
                autoSave: document.getElementById('autoSave').checked,
                soundEffects: document.getElementById('soundEffects').checked,
                animations: document.getElementById('animations').checked,
                showExplanations: document.getElementById('showExplanations').checked,
                defaultTime: document.getElementById('defaultTime').value,
                temperature: document.getElementById('temperature').value,
                aiModel: document.getElementById('aiModel').value
            };
            
            localStorage.setItem('settings', JSON.stringify(settings));
            showMessage('success', 'Configurações salvas com sucesso!');
            closeModal('settingsModal');
        }

        // Export functions
        function showExportOptions() {
            const outputSection = document.getElementById('outputSection');
            if (outputSection.classList.contains('hidden')) {
                 showMessage('error', 'Nenhum resultado para exportar. Gere um conteúdo primeiro.');
                 return;
            }
            // Apenas rola para as opções
            outputSection.scrollIntoView({ behavior: 'smooth' });
             showMessage('success', 'Opções de exportação estão abaixo do resultado.');
        }

        function exportToPDF() {
            if (typeof jspdf === 'undefined') {
                showMessage('error', 'Biblioteca PDF (jsPDF) não carregada.');
                return;
            }
            
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            const outputSection = document.getElementById('outputSection');

            if (outputSection.classList.contains('hidden')) {
                showMessage('error', 'Nenhum resultado para exportar.');
                return;
            }

            let contentText = '';
            
            // Verifica se é resumo
            const summaryContent = document.getElementById('summaryContent');
            if (!document.getElementById('summarySection').classList.contains('hidden')) {
                contentText = summaryContent.innerText; // Pega o texto simples do resumo
            
            } else if (!document.getElementById('quizSection').classList.contains('hidden')) {
                 // Pega o texto das questões
                 const questions = document.querySelectorAll('.question-block');
                 questions.forEach((q, index) => {
                     const questionText = q.querySelector('h4').innerText;
                     contentText += `${questionText}\n`;
                     
                     // Opções
                     q.querySelectorAll('label').forEach(label => {
                         contentText += `- ${label.innerText}\n`;
                     });
                     
                     // Resposta (se visível)
                     const explanation = q.querySelector('.explanation:not(.hidden)');
                     if (explanation) contentText += `${explanation.innerText}\n`;
                     
                     const modelAnswer = q.querySelector('.model-answer:not(.hidden)');
                     if (modelAnswer) contentText += `${modelAnswer.innerText}\n`;
                     
                     contentText += '\n';
                 });
            }
            
            if (!contentText) {
                 showMessage('error', 'Não foi possível extrair o conteúdo para o PDF.');
                 return;
            }

            // Adiciona o texto ao PDF
            doc.text('Estudo.AI - Resultados Exportados', 10, 10);
            // Divide o texto em linhas que cabem na página
            const splitText = doc.splitTextToSize(contentText, 180); 
            doc.text(splitText, 10, 20);
            
            doc.save('estudo-ai-resultados.pdf');
            showMessage('success', 'PDF exportado com sucesso!');
        }

        function exportToJSON() {
            const lastSession = studyStats.sessions[0];
            if (!lastSession) {
                showMessage('error', 'Nenhum resultado recente para exportar.');
                return;
            }
            
            const data = {
                timestamp: lastSession.timestamp,
                type: lastSession.type,
                result: lastSession.result
            };
            
            downloadFile(JSON.stringify(data, null, 2), 'application/json', 'estudo-ai-resultados.json');
            showMessage('success', 'JSON exportado com sucesso!');
        }

        function exportToTXT() {
             const outputSection = document.getElementById('outputSection');
             let contentText = `Estudo.AI - Resultados\nData: ${new Date().toLocaleString()}\n\n`;

            if (outputSection.classList.contains('hidden')) {
                showMessage('error', 'Nenhum resultado para exportar.');
                return;
            }
            
            // Verifica se é resumo
            const summaryContent = document.getElementById('summaryContent');
            if (!document.getElementById('summarySection').classList.contains('hidden')) {
                contentText += summaryContent.innerText;
            
            } else if (!document.getElementById('quizSection').classList.contains('hidden')) {
                 const questions = document.querySelectorAll('.question-block');
                 questions.forEach((q) => {
                     contentText += `${q.querySelector('h4').innerText}\n`;
                     q.querySelectorAll('label').forEach(label => {
                         contentText += `- ${label.innerText}\n`;
                     });
                     const explanation = q.querySelector('.explanation');
                     if (explanation) contentText += `\n${explanation.innerText}\n`;
                     const modelAnswer = q.querySelector('.model-answer');
                     if (modelAnswer) contentText += `\n${modelAnswer.innerText}\n`;
                     contentText += '\n---\n\n';
                 });
            }
            
            downloadFile(contentText, 'text/plain', 'estudo-ai-resultados.txt');
            showMessage('success', 'Arquivo de texto exportado com sucesso!');
        }
        
        function downloadFile(content, mimeType, filename) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function printContent() {
            window.print();
        }

        // Keyboard shortcuts
        function handleKeyboardShortcuts(event) {
            if (event.ctrlKey) {
                switch (event.key.toLowerCase()) {
                    case 'm':
                        event.preventDefault();
                        document.getElementById('generateMultiple').click();
                        break;
                    case 't':
                        event.preventDefault();
                        document.getElementById('generateTrueFalse').click();
                        break;
                    case 's':
                        event.preventDefault();
                        document.getElementById('generateSummary').click();
                        break;
                    case 'd': // Removido
                        event.preventDefault();
                        // toggleTheme();
                        break;
                    case '/':
                    case '?':
                        event.preventDefault();
                        showMessage('success', 'Atalhos: Ctrl+M (Múltipla), Ctrl+T (V/F), Ctrl+S (Resumo)');
                        break;
                }
            }
        }

        // Search functionality
        function toggleSearch() {
            const searchBar = document.getElementById('searchBar');
            searchBar.classList.toggle('hidden');
            
            if (!searchBar.classList.contains('hidden')) {
                document.getElementById('searchInput').focus();
            }
        }

        function searchContent() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const questions = document.querySelectorAll('.question-block');
            
            questions.forEach(question => {
                const text = question.textContent.toLowerCase();
                if (query && !text.includes(query)) {
                    question.style.display = 'none';
                } else {
                    question.style.display = 'block';
                }
            });
        }

        // Scroll functions
        function handleScroll() {
            const scrollButton = document.getElementById('scrollTop');
            if (window.pageYOffset > 300) {
                scrollButton.classList.remove('hidden');
            } else {
                scrollButton.classList.add('hidden');
            }
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Utility functions
        function clearAll() {
            if (confirm('Tem certeza que deseja limpar todos os materiais de estudo e resultados?')) {
                // Limpa textareas
                const textareas = document.querySelectorAll('#studyMaterials textarea');
                textareas.forEach((textarea, index) => {
                    if (index === 0) {
                        textarea.value = ''; // Limpa o primeiro
                        textarea.dispatchEvent(new Event('input'));
                    } else {
                        textarea.closest('.study-block').remove(); // Remove os demais
                    }
                });
                reindexStudyBlocks();
                
                // Limpa lista de arquivos
                document.getElementById('fileList').innerHTML = '';
                
                // Esconde resultados
                document.getElementById('outputSection').classList.add('hidden');
                document.getElementById('timerWidget').classList.add('hidden');
                
                resetTimer();
                
                showMessage('success', 'Dados limpos com sucesso!');
                updateBreadcrumb('Início');
            }
        }

        function regenerateContent() {
            if (lastGenerationType) {
                 showMessage('success', `Regerando ${getSessionTypeLabel(lastGenerationType)}...`);
                 generateContent(lastGenerationType);
            } else {
                showMessage('error', 'Nenhum conteúdo foi gerado ainda para "Regenerar".');
            }
        }

        function markdownToHtml(markdown) {
            if (!markdown) return '';
            
            // Converte o texto simples em HTML, escapando caracteres especiais
            let html = markdown
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');

            // Cabeçalhos
            html = html.replace(/^### (.*$)/gm, '<h3 class="text-lg font-semibold mb-2">$1</h3>');
            html = html.replace(/^## (.*$)/gm, '<h2 class="text-xl font-bold mb-3">$1</h2>');
            html = html.replace(/^# (.*$)/gm, '<h1 class="text-2xl font-bold mb-4">$1</h1>');
            
            // Negrito e Itálico
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // Listas (simplificado, não aninhado)
            html = html.replace(/^\* (.*$)/gm, '<li>$1</li>'); // Listas com *
            html = html.replace(/^\- (.*$)/gm, '<li>$1</li>'); // Listas com -
            
            // Agrupa LIs em ULs
            html = html.replace(/((<li>.*<\/li>\s*)+)/g, '<ul class="list-disc pl-5 mb-4">$1</ul>');
            
            // Parágrafos (qualquer linha que não seja um H ou LI)
            // Divide por quebra de linha, agrupa linhas não vazias em <p>
            let paragraphs = [];
            let currentParagraph = [];
            
            html.split('\n').forEach(line => {
                if (!line.trim()) {
                    if (currentParagraph.length > 0) {
                        paragraphs.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                } else if (!line.startsWith('<h') && !line.startsWith('<ul') && !line.startsWith('<li') && !line.startsWith('</ul')) {
                    currentParagraph.push(line);
                } else {
                    if (currentParagraph.length > 0) {
                         paragraphs.push(`<p>${currentParagraph.join('<br>')}</p>`);
                         currentParagraph = [];
                    }
                    paragraphs.push(line); // Adiciona o H, UL, LI
                }
            });
            
            if (currentParagraph.length > 0) {
                 paragraphs.push(`<p>${currentParagraph.join('<br>')}</p>`);
            }

            html = paragraphs.join('\n');
            
            // Limpa quebras de linha extras e parágrafos vazios
            html = html.replace(/<p><\/p>/g, '');
            html = html.replace(/<p><br><\/p>/g, '<br>');
            html = html.replace(/(<br>\s*)+/g, '<br>'); // Remove quebras de linha múltiplas
            html = html.replace(/<\/li><br>/g, '</li>');
            html = html.replace(/<\/ul><br>/g, '</ul>');
            html = html.replace(/<br><ul>/g, '<ul>');
            html = html.replace(/<br><li>/g, '<li>');

            return html;
        }


        // Click outside modal to close
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize recent sessions display
        updateRecentSessions();
    </script>
    <!-- #################### FIM DO SCRIPT #################### -->
</body>
</html>

